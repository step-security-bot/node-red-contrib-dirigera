<script type="text/javascript">

  RED.nodes.registerType('dirigera-config', {
    category: 'config',
    defaults: {
      name: { value: "" },
    },
    credentials: {
      hubAddress: { type: "text" },
      hubAccessCode: { type: "text" },
    },
    label: function () {
      if (this.name) {
        return this.name;
      }
      let defaultName = "dirigeraHub"
      if (!this.hubAccessCode) {
        defaultName += " (missing hubAccess Code)"
      }
      return defaultName;
    },
    oneditprepare: function () {
      const node = this
      // $('#node-input-lookup-hubAddress-button').click(function () {
      //   $.getJSON('ikeaDirigera/discover', { nodeId: nodeID }, function (resp) {
      //     let ipAddress = JSON.parse(resp).ip;
      //     $('#node-config-input-hubAddress').val(ipAddress)
      //   })
      // });
      $('#node-input-lookup-hubAccessCode-tip').hide()
      $('#node-input-lookup-hubAccessCode-button').click(function () {
        $('#node-input-lookup-hubAccessCode-tip').text('Press button on hub now within 60 sec !!!')
        $('#node-input-lookup-hubAccessCode-tip').show()
        $('#node-config-input-hubAccessCode').val('')
        $.get('ikeaDirigera/auth', { hubAddress: $('#node-config-input-hubAddress').val(), clientName: node.name }, function (resp) {
          console.log(resp)
          let response = JSON.parse(resp);
          if (response.error || !response.access_token) {
            $('#node-input-lookup-hubAccessCode-tip').text('Error: ' + response.error)
            return
          }
          $('#node-input-lookup-hubAccessCode-tip').text('Access code received OK. Ready to save this config')
          $('#node-config-input-hubAccessCode').val(response.access_token)
        })
      });
    }
  });
</script>

<script type="text/html" data-template-name="dirigera-config">
  <div class="form-row">
      <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-config-input-name" placeholder="Optional name">
  </div>
  <div class="form-row">
      <label for="node-config-input-hubAddress"><i class="fa fa-globe"></i> Hub address ip/hostname</label>
      <div style="width: 70%; display: inline-flex;">
      <input type="text" id="node-config-input-hubAddress" placeholder="192.168.1.4" style="flex-grow: 1;">
      <!-- <a id="node-input-lookup-hubAddress-button" class="editor-button" style="margin-left: 10px;"><i class="fa fa-refresh"></i></a> -->
    </div>
  </div>
  <div class="form-row">
      <label for="node-config-input-hubAccessCode"><i class="fa fa-key"></i> Access code</label>
      <div style="width: 70%; display: inline-flex;">
      <input type="text" id="node-config-input-hubAccessCode" placeholder="asda213qas" style="flex-grow: 1;" autocomplete="off">
      <a id="node-input-lookup-hubAccessCode-button" class="editor-button" style="margin-left: 10px;"><i class="fa fa-refresh"></i></a>
    </div>
    <div class="form-row"></div>
    <div class="form-tips" id="node-input-lookup-hubAccessCode-tip">.</div>
    <img src="push-button.jpg" alt="">
  </div>
  </div>
</script>

<script type="text/javascript">
  const updateTypes = (response, choiceType) => {

  }
  const updateRooms = (response, choiceRoom) => {
    $('#node-input-choiceRoom').find('option').remove();
    let rooms = Object.keys(response[$('#node-input-choiceType').val()])
    if (!Array.isArray(rooms) || rooms.length <= 0) { return; }
    $.each(rooms, function (i, room) {
      let opt = {};
      opt.value = room;
      opt.text = room;
      if (choiceRoom === opt.value) {
        opt.selected = "selected";
      } else if ($('#node-input-choiceType').find(":selected") && $('#node-input-choiceType').find(":selected").text() === opt.value) {
        opt.selected = "selected";
      }
      $('#node-input-choiceRoom').append($('<option>', opt));
    });
  }
  RED.nodes.registerType('dirigera', {
    category: 'request',
    color: '#e55050',
    defaults: {
      name: { value: "" },
      server: { type: "dirigera-config", required: true },
      choiceType: { value: "" },
      choiceRoom: { value: "" }
    },
    inputs: 1,
    outputs: 1,
    icon: "white-globe.svg",
    label: function () {
      return this.name || "Digigra:" + this.choiceRoom;
    },
    oneditprepare: function () {
      const node = this
      let configNodeId = $('#node-input-server').find(":selected").val();
      if (configNodeId == null || configNodeId === '_ADD_') { return; }
      $.get('ikeaDirigera/dirigera', { nodeId: configNodeId }, function (resp) {
        let response = JSON.parse(resp)
        $('#node-input-choiceType').find('option').remove();
        let devices = Object.keys(response)
        if (!Array.isArray(devices) || devices.length <= 0) { return; }
        $.each(devices, function (i, device) {
          let opt = {};
          opt.value = device;
          opt.text = device;
          if (node.choiceType === opt.value) {
            opt.selected = "selected";
          }
          $('#node-input-choiceType').append($('<option>', opt));
        });
        $('#node-input-choiceType').change(function () {
          updateRooms(response, node.choiceRoom)
        });
        updateRooms(response, node.choiceRoom)
      })
    },
    // oneditsave: function () {
    //   this.choiceType = $('#node-input-choiceType').find(":selected").text();
    //   this.choiceRoom = $('node-input-choiceRoom').find(":selected").text();
    // }
  });
</script>

<script type="text/html" data-template-name="dirigera">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Optional name">
  </div>
  <div class="form-row">
      <label for="node-input-server"><i class="fa fa-cog"></i> Config</label>
      <input type="text" id="node-input-server">
  </div>
  <div class="form-row">
      <label for="node-input-choiceType"><i class="fa fa-window-maximize"></i> Choose type</label>
      <select value="" id="node-input-choiceType">
      </select>
  </div>
  <div class="form-row">
    <label for="node-input-choiceRoom"><i class="fa fa-home"></i> Choose room</label>
    <select value="" id="node-input-choiceRoom">
    </select>
</div>
</script>

<script type="text/html" data-help-name="dirigera">
</script>