<script type="text/javascript">

  RED.nodes.registerType('dirigera-config', {
    category: 'config',
    defaults: {
      name: { value: "" },
    },
    credentials: {
      hubAddress: { type: "text" },
      hubAccessCode: { type: "text" },
    },
    label: function () {
      return this.name || "dirigeraHub"
    },
    oneditprepare: function () {
      const node = this
      $('#node-input-lookup-hubAccessCode-tip').hide()
      $('#node-input-lookup-hubAccessCode-button').click(function () {
        $('#node-input-lookup-hubAccessCode-tip').text('Press button on hub now within 60 sec !!!')
        $('#node-input-tip-image').attr("src", "https://raw.githubusercontent.com/zinen/node-red-contrib-dirigera/9554afe12caf6b42eff6c15243f86541dd22e0ee/image/push-button.jpg");
        $('#node-input-lookup-hubAccessCode-tip').show()
        $('#node-config-input-hubAccessCode').val('')
        $.get('ikeaDirigera/auth', { hubAddress: $('#node-config-input-hubAddress').val(), clientName: $('#node-config-input-name').val() }, function (resp) {
          let response = JSON.parse(resp);
          if (response.error || !response.access_token) {
            $('#node-input-lookup-hubAccessCode-tip').text('Error: ' + response.error)
            $('#node-input-tip-image').attr("src", "");
            return
          }
          $('#node-input-lookup-hubAccessCode-tip').text('Access code received OK. Ready to save this config')
          $('#node-input-tip-image').attr("src", "");
          $('#node-config-input-hubAccessCode').val(response.access_token)
        })
      });
    }
  })
</script>

<script type="text/html" data-template-name="dirigera-config">
  <div class="form-row">
      <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-config-input-name" placeholder="Optional name. If filled before requesting access code it can be found in Dirigera's own app">
  </div>
  <div class="form-row">
      <label for="node-config-input-hubAddress"><i class="fa fa-globe"></i> Hub address ip/hostname</label>
      <div style="width: 70%; display: inline-flex;">
      <input type="text" id="node-config-input-hubAddress" placeholder="192.168.1.4" style="flex-grow: 1;">
      <!-- <a id="node-input-lookup-hubAddress-button" class="editor-button" style="margin-left: 10px;"><i class="fa fa-refresh"></i></a> -->
    </div>
  </div>
  <div class="form-row">
      <label for="node-config-input-hubAccessCode"><i class="fa fa-key"></i> Access code</label>
      <div style="width: 70%; display: inline-flex;">
      <input type="text" id="node-config-input-hubAccessCode" placeholder="Auto filled. Press ==>" style="flex-grow: 1;" autocomplete="off">
      <a id="node-input-lookup-hubAccessCode-button" class="editor-button" style="margin-left: 10px;">Get access code</a>
    </div>
  </div>
  <div class="form-row">
    <div class="form-tips" id="node-input-lookup-hubAccessCode-tip">.</div>
    <img id="node-input-tip-image" src="" alt="">
  </div>
  </div>
</script>

<script type="text/javascript">
  const updateType = (node) => {
    let configNodeId = $('#node-input-server').find(":selected").val();
    if (configNodeId == null || configNodeId === '_ADD_') { return; }
    $.get('ikeaDirigera/dirigera', { nodeId: configNodeId }, function (resp) {
      if (!resp) return
      let response = JSON.parse(resp)
      $('#node-input-choiceType').find('option').remove();
      let deviceTypes = Object.keys(response)
      if (!Array.isArray(deviceTypes) || deviceTypes.length <= 0) return
      $.each(deviceTypes, function (i, deviceTypes) {
        let opt = {};
        opt.value = deviceTypes;
        opt.text = deviceTypes;
        if (node.choiceType === opt.value) {
          opt.selected = "selected";
        }
        $('#node-input-choiceType').append($('<option>', opt));
      });
      $('#node-input-choiceType').change(function () {
        updateRooms(response, node.choiceRoomID)
      });
      updateRooms(response, node.choiceRoomID)
    })
  }
  const updateRooms = (response, choiceRoomID) => {
    $('#node-input-choiceRoomID').find('option').remove();
    let rooms = response[$('#node-input-choiceType').val()]
    if (!Array.isArray(rooms) || rooms.length <= 0) { return; }
    $.each(rooms, function (i, room) {
      let opt = {};
      opt.value = room.id;
      opt.text = room.name;
      if (choiceRoomID === opt.value) {
        opt.selected = "selected";
      }
      $('#node-input-choiceRoomID').append($('<option>', opt));
    });
  }
  RED.nodes.registerType('dirigera', {
    category: 'homesmart',
    color: '#fbd914',
    defaults: {
      name: { value: "" },
      server: { type: "dirigera-config", required: true },
      choiceType: { value: "" },
      choiceRoom: { value: "" },
      choiceRoomID: { value: "" }
    },
    inputs: 1,
    outputs: 1,
    icon: 'font-awesome/fa-home',
    label: function () {
      return this.name || this.choiceType+": " + this.choiceRoom;
    },
    oneditprepare: function () {
      const node = this
      updateType(node)

      $('#node-input-server').change(function () {
        $('#node-input-choiceType').find('option').remove();
        $('#node-input-choiceRoomID').find('option').remove();
        updateType(node)
      });
    },
    oneditsave: function () {
      this.choiceRoom = $('#node-input-choiceRoomID').find(":selected").text()
    }
  });
</script>

<script type="text/html" data-template-name="dirigera">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Optional name">
  </div>
  <div class="form-row">
      <label for="node-input-server"><i class="fa fa-cog"></i> Config</label>
      <input type="text" id="node-input-server">
  </div>
  <div class="form-row">
      <label for="node-input-choiceType"><i class="fa fa-window-maximize"></i> Choose type</label>
      <select value="" id="node-input-choiceType">
      </select>
  </div>
  <div class="form-row">
    <label for="node-input-choiceRoomID"><i class="fa fa-home"></i> Choose room</label>
    <select value="" id="node-input-choiceRoomID">
    </select>
</div>
</script>

<script type="text/html" data-help-name="dirigera">
  <h3>Help</h3>
  If every dropdown is empty and you just finished your config with the address and access code. Try deploy and reopen this menu.

  <h3>Input</h3>
  <ul>
    <code>msg.cmd</code>  as input will send that command to the hub. If let empty will return status of devices in selected room.
  </ul>
  <h3>Output</h3>
  <ul>
    <code>msg.payload</code> return output data from the hub.
    <code>msg.cmd</code> available commands to send to the devices.
  </ul>

</script>